---
- name: Configure SSO for Foreman
  hosts: foreman
  become: true
  vars_files:
    - host_vars/foreman_vars.yml
  roles:
    - role: keycloak_setup
  post_tasks:
    - name: Verify Keycloak installation
      uri:
        url: "https://localhost:{{ keycloak_https_port }}/health/ready"
        method: GET
        status_code: 200
        validate_certs: false
      register: result
      until: result.status == 200
      retries: 30
      delay: 10

    - name: Verify Foreman SSO configuration
      uri:
        url: "https://localhost/users/auth/keycloak"
        method: GET
        status_code: 200
        validate_certs: false
      register: result
      until: result.status == 200
      retries: 30
      delay: 10 