---
# Keycloak configuration tasks

- name: Check if kc.sh exists
  ansible.builtin.stat:
    path: /opt/keycloak/bin/kc.sh
  register: kc_script

- name: Check if standalone.sh exists (older versions)
  ansible.builtin.stat:
    path: /opt/keycloak/bin/standalone.sh
  register: standalone_script
  when: not kc_script.stat.exists

- name: Stop Keycloak service if running
  ansible.builtin.systemd:
    name: keycloak
    state: stopped
  ignore_errors: yes

- name: Remove data directory for clean start
  ansible.builtin.file:
    path: /opt/keycloak/data
    state: absent
  become: yes

- name: Create keycloak.conf file
  ansible.builtin.template:
    src: keycloak.conf.j2
    dest: /opt/keycloak/conf/keycloak.conf
    owner: keycloak
    group: keycloak
    mode: '0640'

- name: Create admin user with add-user script
  ansible.builtin.shell:
    cmd: |
      /opt/keycloak/bin/add-user-keycloak.sh -r master -u {{ keycloak_admin_user }} -p {{ keycloak_admin_password }}
    chdir: /opt/keycloak
  become: yes
  become_user: keycloak
  register: add_user_result
  changed_when: add_user_result.rc == 0
  ignore_errors: yes

- name: Configure Keycloak (newer versions)
  ansible.builtin.command:
    cmd: "/opt/keycloak/bin/kc.sh build"
    chdir: /opt/keycloak
  become: yes
  become_user: keycloak
  register: kc_build
  changed_when: kc_build.rc == 0
  when: kc_script.stat.exists

- name: Update Keycloak service file
  ansible.builtin.template:
    src: keycloak.service.j2
    dest: /etc/systemd/system/keycloak.service
    owner: root
    group: root
    mode: '0644'

- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Enable Keycloak systemd service
  ansible.builtin.systemd:
    name: keycloak
    enabled: yes
    state: started
  register: keycloak_service

- name: Wait for Keycloak to start (HTTP)
  ansible.builtin.uri:
    url: "http://localhost:8080/"
    method: GET
  register: result
  until: result.status is defined and result.status == 200
  retries: 30
  delay: 10
  ignore_errors: yes
  
- name: Check if Keycloak is running
  ansible.builtin.command: 
    cmd: systemctl status keycloak
  register: keycloak_status
  changed_when: false
  failed_when: false
  when: result.status is undefined or result.status != 200

- name: Show Keycloak status
  ansible.builtin.debug:
    var: keycloak_status.stdout_lines
  when: keycloak_status is defined and keycloak_status.stdout_lines is defined

- name: Wait for admin REST endpoint to be available
  ansible.builtin.uri:
    url: "http://localhost:8080/admin/"
    method: GET
  register: admin_result
  until: admin_result.status is defined
  retries: 30
  delay: 10
  ignore_errors: yes

- name: Manually create admin user
  ansible.builtin.shell:
    cmd: |
      echo "Creating admin user with direct KCADM call"
      export JAVA_OPTS="-Dkeycloak.profile.feature.admin_fine_grained_authz=enabled" 
      /opt/keycloak/bin/kc.sh show-config
      /opt/keycloak/bin/kc.sh build
      
      # Try direct token request
      curl -d "client_id=admin-cli" -d "username={{ keycloak_admin_user }}" -d "password={{ keycloak_admin_password }}" -d "grant_type=password" "http://localhost:8080/realms/master/protocol/openid-connect/token"
    chdir: /opt/keycloak
  become: yes
  become_user: keycloak
  register: manual_admin
  changed_when: false
  ignore_errors: yes

- name: Debug manual admin creation
  ansible.builtin.debug:
    var: manual_admin

- name: Create Foreman realm and client (one attempt)
  ansible.builtin.shell:
    cmd: |
      # Try with environment variables
      export KEYCLOAK_ADMIN={{ keycloak_admin_user }}
      export KEYCLOAK_ADMIN_PASSWORD={{ keycloak_admin_password }}
      
      # Try to create realm with kcadm
      /opt/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080 --realm master --user {{ keycloak_admin_user }} --password {{ keycloak_admin_password }}
      
      if [ $? -eq 0 ]; then
        echo "Authentication successful, creating realm"
        /opt/keycloak/bin/kcadm.sh create realms -s realm={{ foreman_realm_name }} -s enabled=true -s displayName='Foreman SSO Realm'
        
        echo "Creating client"
        /opt/keycloak/bin/kcadm.sh create clients -r {{ foreman_realm_name }} -s clientId={{ foreman_client_id }} -s enabled=true -s redirectUris=["https://{{ ansible_host }}/users/auth/keycloak/callback"] -s webOrigins=["+"] -s standardFlowEnabled=true -s directAccessGrantsEnabled=true -s rootUrl="https://{{ ansible_host }}" -s baseUrl="/users/auth/keycloak" -s protocol=openid-connect
      else
        echo "Authentication failed, will not create realm and client"
        exit 0
      fi
    chdir: /opt/keycloak
  become: yes
  become_user: keycloak
  register: realm_client_result
  changed_when: false
  ignore_errors: yes

- name: Debug realm and client creation
  ansible.builtin.debug:
    var: realm_client_result 